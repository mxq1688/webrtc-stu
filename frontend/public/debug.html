<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§»åŠ¨ç«¯WebSocketè°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .log { background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 10px 0; max-height: 300px; overflow-y: scroll; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background: #007bff; color: white; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± ç§»åŠ¨ç«¯WebSocketè¿æ¥è°ƒè¯•</h1>
        
        <div>
            <p><strong>å½“å‰åœ°å€:</strong> <span id="currentUrl"></span></p>
            <p><strong>åè®®:</strong> <span id="protocol"></span></p>
            <p><strong>ä¸»æœº:</strong> <span id="hostname"></span></p>
        </div>
        
        <div>
            <button onclick="testWebSocket()">ğŸ”— æµ‹è¯•WebSocketè¿æ¥</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="log" id="log">
            <div class="info">ğŸ“‹ ç‚¹å‡»"æµ‹è¯•WebSocketè¿æ¥"å¼€å§‹è¯Šæ–­...</div>
        </div>
    </div>

    <script>
        // æ˜¾ç¤ºå½“å‰é¡µé¢ä¿¡æ¯
        document.getElementById('currentUrl').textContent = window.location.href;
        document.getElementById('protocol').textContent = window.location.protocol;
        document.getElementById('hostname').textContent = window.location.hostname;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function testWebSocket() {
            clearLog();
            log('ğŸš€ å¼€å§‹WebSocketè¿æ¥æµ‹è¯•...', 'info');
            
            const host = window.location.hostname;
            const protocol = window.location.protocol;
            
            // ç¡®å®šWebSocket URL
            let wsUrl;
            if (protocol === 'https:') {
                wsUrl = `wss://${host}:8443/ws`;
                log(`ğŸ”’ HTTPSç¯å¢ƒï¼Œä½¿ç”¨WSS: ${wsUrl}`, 'info');
            } else {
                wsUrl = `ws://${host}:8080/ws`;
                log(`ğŸ”§ HTTPç¯å¢ƒï¼Œä½¿ç”¨WS: ${wsUrl}`, 'info');
            }
            
            // æ·»åŠ æµ‹è¯•å‚æ•°
            const testParams = new URLSearchParams({
                userId: 'test-user-' + Date.now(),
                roomId: 'test-room',
                username: 'TestUser'
            });
            
            const fullWsUrl = `${wsUrl}?${testParams.toString()}`;
            log(`ğŸ“¡ å®Œæ•´WebSocket URL: ${fullWsUrl}`, 'info');
            
            try {
                log('ğŸ”— æ­£åœ¨å»ºç«‹WebSocketè¿æ¥...', 'info');
                const ws = new WebSocket(fullWsUrl);
                
                ws.onopen = function(event) {
                    log('âœ… WebSocketè¿æ¥æˆåŠŸå»ºç«‹ï¼', 'success');
                    log('ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯...', 'info');
                    
                    // å‘é€æµ‹è¯•æ¶ˆæ¯
                    const testMessage = {
                        type: 'test',
                        data: 'Hello from mobile!'
                    };
                    ws.send(JSON.stringify(testMessage));
                };
                
                ws.onmessage = function(event) {
                    log(`ğŸ“¥ æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯: ${event.data}`, 'success');
                };
                
                ws.onclose = function(event) {
                    log(`âŒ WebSocketè¿æ¥å…³é—­ - ä»£ç : ${event.code}, åŸå› : ${event.reason || 'æœªçŸ¥'}`, 'error');
                    
                    if (event.code === 1006) {
                        log('ğŸ’¡ è¿æ¥å¼‚å¸¸å…³é—­ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨é—®é¢˜', 'error');
                    }
                };
                
                ws.onerror = function(error) {
                    log(`ğŸš¨ WebSocketè¿æ¥é”™è¯¯: ${error}`, 'error');
                    log('ğŸ” å¯èƒ½çš„åŸå› :', 'error');
                    log('  1. æœåŠ¡å™¨æœªå¯åŠ¨æˆ–ç«¯å£è¢«å ç”¨', 'error');
                    log('  2. é˜²ç«å¢™é˜»æ­¢è¿æ¥', 'error');
                    log('  3. SSLè¯ä¹¦é—®é¢˜ï¼ˆHTTPSç¯å¢ƒï¼‰', 'error');
                    log('  4. ç½‘ç»œè¿æ¥é—®é¢˜', 'error');
                };
                
                // 5ç§’åå…³é—­æµ‹è¯•è¿æ¥
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        log('â° æµ‹è¯•å®Œæˆï¼Œå…³é—­è¿æ¥', 'info');
                        ws.close();
                    }
                }, 5000);
                
            } catch (error) {
                log(`ğŸ’¥ åˆ›å»ºWebSocketæ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        window.onload = function() {
            log('ğŸ“± ç§»åŠ¨ç«¯WebSocketè°ƒè¯•å·¥å…·å·²åŠ è½½', 'info');
            log(`ğŸŒ å½“å‰ç¯å¢ƒ: ${window.location.protocol} @ ${window.location.hostname}`, 'info');
            log(`ğŸ“‹ ç”¨æˆ·ä»£ç†: ${navigator.userAgent}`, 'info');
        };
    </script>
</body>
</html> 